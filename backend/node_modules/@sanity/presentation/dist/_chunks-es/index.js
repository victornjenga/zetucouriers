import{jsx as e,jsxs as t,Fragment as n}from"react/jsx-runtime";import{useState as r,useMemo as i,useEffect as o,createContext as s,useContext as c,useCallback as a,createElement as l,useRef as d,useLayoutEffect as p,lazy as u,Suspense as m}from"react";import{useDocumentStore as h,isRecord as f,isReference as y,defineLocaleResourceBundle as g,useTranslation as v,defineDocumentFieldAction as w,useWorkspace as b,pathToString as _,getPublishedId as P,definePlugin as j,isDocumentSchemaType as x}from"sanity";import{ComposeIcon as I,InfoOutlineIcon as T,ChevronRightIcon as S,DesktopIcon as O,WarningOutlineIcon as k,ErrorOutlineIcon as z,MasterDetailIcon as D}from"@sanity/icons";import{Card as A,Flex as E,Box as $,Text as C,Spinner as B,Stack as R,rem as U}from"@sanity/ui";import{styled as H}from"styled-components";import L from"lodash.get";import{Observable as N,switchMap as M,isObservable as Q,from as q,map as F,of as G,combineLatest as J,mergeAll as K,scan as V}from"rxjs";import{useIntentLink as W,useRouter as X,encodeJsonParams as Y,route as Z}from"sanity/router";import{uuid as ee}from"@sanity/uuid";const te=I,ne="presentation",re="Presentation",ie="sanity/structure/comments",oe="presentation",se=3e3,ce="2023-10-16",ae=1e3,le=100,de=2048;function pe(e,t,n){return{...e,[t]:n}}function ue(e={}){return t=>new N((e=>t.subscribe(e))).pipe(M((t=>{const n=(r=t,Object.keys(r)).map((e=>{const n=t[e];return Q(n)?q(n).pipe(F((t=>[e,t]))):G([e,n])}));var r;return e.wait?J(n).pipe(F((e=>e.reduce(((e,[t,n])=>pe(e,t,n)),{})))):q(n).pipe(K(),V(((e,[t,n])=>pe(e,t,n)),{}))})))}const me={locations:[]};function he(e,t,n){if(!e||"object"!=typeof e)return G(e);const r=function(e){return y(e)?e._ref:"_id"in e?e._id:void 0}(e),i=function(e,t){const n=e?{...t,_id:e}:{...t};return"reference"===n._type&&(delete n._type,delete n._ref,delete n._weak,delete n._dataset,delete n._projectId,delete n._strengthenOnPublish),n}(r,e),o=t.filter((e=>!(e[0]in i)));if(r&&o.length){return function(e,t,n){const r=`*[_id==$id][0]{${t.join(", ")}}`,i={id:e};return n.listenQuery(r,i,{perspective:"previewDrafts"})}(r,[...new Set(o.map((e=>e[0])))],n).pipe(M((e=>e?he(e,t,n):G(null))))}const s={};t.forEach((e=>{const[t,...n]=e;s[t]||(s[t]=[]),s[t].push(n)}));const c=Object.keys(s).reduce(((t,r)=>{const i=s[r].filter((e=>e.length>0));return 0===i.length?t[r]=f(e)?e[r]:void 0:t[r]=he(e[r],i,n),t}),i);return G(c).pipe(ue({wait:!0}))}function fe(e){const{id:t,resolvers:n,type:s}=e,c=h(),[a,l]=r(me),d=n&&("function"==typeof n?n:n[s]),[p,u]=r(d?"resolving":"empty"),m=i((()=>{if(d){if("function"==typeof d){const e=d({id:t,type:s},{documentStore:c});return Q(e)?e:G(e)}return"select"in d&&"resolve"in d?function(e,t,n){const{select:r}=t;return he({_type:"reference",_ref:e},Object.values(r).map((e=>String(e).split(".")))||[],n).pipe(F((e=>Object.keys(r).reduce(((t,n)=>(t[n]=L(e,r[n]),t)),{}))),F(t.resolve))}(t,d,c):G(d)}}),[c,t,d,s]);return o((()=>{const e=m?.subscribe((e=>{l(e||me),u(e?"resolved":"empty")}));return()=>e?.unsubscribe()}),[m]),{state:a,status:p}}const ye="presentation",ge=g({locale:"en-US",namespace:ye,resources:()=>import("./resources.js")}),ve=s(null);function we(){const e=c(ve);if(!e)throw new Error("Presentation context is missing");return e}const be={positive:T,caution:k,critical:z};function _e(i){const{documentId:o,isResolving:s,options:d,schemaType:p,showPresentationTitle:u}=i,{locations:m,message:h,tone:f}=i.state,y=m?.length||0,{t:g}=v(ye),w=c(ve),[b,_]=r(!1),P=a((()=>{y&&_((e=>!e))}),[y]),j=s?g("locations-banner.resolving.text"):h||g("locations-banner.locations-count",{count:y});return e(A,{padding:1,radius:2,border:!0,tone:f,children:t("div",{style:{margin:-1},children:[!m&&t(E,{align:"flex-start",gap:3,padding:3,children:[f&&e($,{flex:"none",children:e(C,{size:1,children:l(be[f])})}),e($,{flex:1,children:t(C,{size:1,weight:"medium",children:[u&&t(n,{children:[d.title||re," · "]}),j]})})]}),m&&t(n,{children:[e(A,{as:y?"button":void 0,onClick:P,padding:3,radius:1,tone:"inherit",children:t(E,{gap:3,children:[e($,{flex:"none",children:s?e(B,{size:1}):e(C,{size:1,children:0===y?e(T,{}):e(S,{style:{transform:`rotate(${b?"90deg":0})`,transition:"transform 100ms ease-in-out"}})})}),e($,{flex:1,children:t(C,{size:1,weight:"medium",children:[u&&t(n,{children:[d.title||re," · "]}),j]})})]})}),e(R,{hidden:!b,marginTop:1,space:1,children:m.map(((t,n)=>e(Pe,{active:(d.name||ne)===w?.name&&t.href===w?.params.preview,documentId:o,documentType:p.name,node:t,toolName:d.name||ne},n)))})]})]})})}function Pe(n){const{documentId:r,documentType:i,node:o,active:s,toolName:d}=n,p=c(ve),u=d===function(){try{return we().name}catch{return}}(),m=p?.navigate,h=W({intent:"edit",params:{id:r,type:i,mode:"presentation",presentation:d,...p?.structureParams,preview:o.href}}),f=a((()=>{m?.({},{preview:o.href})}),[o.href,m]);return l(A,{...u?{}:h,as:"a",key:o.href,onClick:u?f:h.onClick,padding:3,radius:1,pressed:s,tone:"inherit"},t(E,{gap:3,children:[e($,{flex:"none",children:e(C,{size:1,children:e(O,{})})}),t(R,{flex:1,space:2,children:[e(C,{size:1,weight:"medium",children:o.title}),e(C,{muted:!0,size:1,textOverflow:"ellipsis",children:o.href})]})]}))}const je=s(null),xe=H(R)`
  min-height: ${U(42)};

  & + &:empty {
    display: none;
  }
`;function Ie(t){const{documentId:n,options:r,schemaType:i}=t,o=c(je),{state:s,status:a}=fe({id:n,resolvers:r.resolve?.locations||r.locate,type:i.name});if(o&&o.options[0]!==r||"empty"===a)return null;const l=o?.options||[];return e(xe,{marginBottom:5,space:5,children:e(R,{space:2,children:l.map(((t,r)=>e(_e,{documentId:n,isResolving:"resolving"===a,options:t,schemaType:i,showPresentationTitle:l.length>1,state:s},r)))})})}function Te(t){const{children:n,options:o}=t,s=c(je),l=s?.register,[u,m]=r((()=>[])),h=a((e=>l?l(e):(m((t=>[e].concat(t))),()=>{m((t=>t.filter((t=>t!==e))))})),[l]),f=d(h);f.current=h;const y=i((()=>({options:s?.options||u,register:h})),[u,s,h]);return p((()=>f.current(o)),[o]),e(je.Provider,{value:y,children:n})}const Se=w({name:"presentation/openInStructure",useAction({documentId:e,documentType:t,path:n}){const r=b(),{navigateIntent:o}=X(),s=c(ve),a=i((()=>function(e,t,n){const r=e.map((e=>{const r=e.canHandleIntent?.("edit",{id:t,type:n,mode:"structure"},{});return{tool:e,match:r}})),i=r.filter((e=>f(e.match)&&e.match.mode));return i.length>0?i[0].tool:r.filter((e=>e.match))[0]?.tool}(r.tools,e,t)),[e,t,r.tools]);return{type:"action",hidden:!s||n.length>0||!a,icon:a?.icon||D,title:`Open in ${a?.title||"Structure"}`,onAction(){o("edit",{id:e,type:t,mode:"structure",path:_(n)})},renderAsButton:!0}}});const Oe=["preview","perspective","viewport"];function ke(e,t,n,r){const{id:i,mode:o,path:s,presentation:c,type:a,...l}=t,d={...(n?._searchParams||[]).filter((([e])=>Oe.includes(e))).reduce(((e,[t,n])=>({...e,[t]:n})),{}),...l};return"edit"===e&&i?{type:a||"*",id:P(i),path:s,_searchParams:Object.entries(d)}:"create"===e?(d.preview=d.preview||new URLSearchParams(window.location.search).get("preview")||"/",r&&"object"==typeof r&&(d.templateParams=Y(r)),{type:a||"*",id:i||ee(),_searchParams:Object.entries(d)}):{intent:e,params:t,payload:r}}const ze=Z.create("/",{__unsafe_disableScopedSearchParams:!0},[Z.intents("/intent"),Z.create(":type",[Z.create(":id",[Z.create(":path")])])]),De=u((()=>import("./PresentationTool.js"))),Ae=u((()=>import("./BroadcastDisplayedDocument.js")));function Ee(e){return e}function $e(e){return e}const Ce=j((n=>{const r=n.name||ne;"locate"in n&&console.warn("Presentation’s `locate` option is deprecated. Use `resolve.locations` instead.");const i=!(!n.resolve?.locations&&!n.locate);return{i18n:{bundles:[ge]},document:{unstable_fieldActions:e=>[...e.filter((e=>e.name!==Se.name)),Se]},form:{components:{input:function(r){const o=r.value,s=o?._id?P(o?._id):void 0;return x(r.schemaType)?t(Te,{options:n,children:[i&&s&&e(Ie,{documentId:s,options:n,schemaType:r.schemaType}),r.renderDefault(r),e(m,{children:e(Ae,{value:o},s)},"broadcast-displayed-document")]}):r.renderDefault(r)}}},tools:[{icon:n.icon||te,name:r,title:n.title,component:De,options:n,canHandleIntent:(e,t)=>"create"===e?function(e){return"type"in e&&(!("presentation"in e)||e.presentation===r)&&(!("template"in e)||{template:!0})}(t):"edit"===e&&function(e){return"type"in e&&"id"in e&&(!("presentation"in e)||e.presentation===r)&&(!("mode"in e)||{mode:e.mode===oe})}(t),getIntentState:ke,router:ze}]}})),Be=s(null);function Re(){const e=c(Be);if(!e)throw new Error("Presentation navigate context is missing");return e}const Ue=s(null);function He(e=!0){const t=c(Ue);if(e&&!t)throw new Error("Presentation params context is missing");return t}export{ce as A,ie as C,ne as D,oe as E,de as L,se as M,Be as P,Ue as a,ve as b,ae as c,He as d,le as e,Re as f,Ee as g,$e as h,Ce as i,ye as p,we as u};//# sourceMappingURL=index.js.map
